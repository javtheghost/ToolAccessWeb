<div class="reports-container">
  <p-toast
    position="bottom-right"
    [baseZIndex]="9999999"
    [autoZIndex]="false"
    [preventDuplicates]="true"
    [showTransformOptions]="'translateX(100%)'"
    [hideTransformOptions]="'translateX(100%)'">
  </p-toast>

  <!-- Header con estad√≠sticas r√°pidas -->
  <div class="header-section">
    <div class="header-content">
      <div class="header-title">
        <h1>üìä Panel de Reportes</h1>
        <p class="header-subtitle">Genera reportes detallados y visualiza estad√≠sticas del sistema</p>
      </div>
      <div class="header-actions">
        <p-button
          label="Generar Reporte"
          icon="pi pi-file-pdf"
          (onClick)="generarReporte()"
          [loading]="loading"
          [disabled]="!isFormValid"
          styleClass="p-button-primary header-btn">
        </p-button>
      </div>
    </div>
  </div>

  <!-- Estad√≠sticas r√°pidas -->
  <div class="stats-grid" *ngIf="estadisticas">
    <div class="stat-card">
      <div class="stat-icon herramientas">
        <i class="pi pi-wrench"></i>
      </div>
      <div class="stat-content">
        <h3>{{ estadisticas.herramientas.total_herramientas }}</h3>
        <p>Herramientas Totales</p>
        <div class="stat-details">
          <span class="stat-item disponible" *ngIf="estadisticas.herramientas.disponibles > 0">
            <i class="pi pi-check-circle"></i>
            {{ estadisticas.herramientas.disponibles }} disponibles
          </span>
          <span class="stat-item prestada" *ngIf="estadisticas.herramientas.prestadas > 0">
            <i class="pi pi-clock"></i>
            {{ estadisticas.herramientas.prestadas }} prestadas
          </span>
          <span class="stat-item info" *ngIf="estadisticas.herramientas.disponibles === 0 && estadisticas.herramientas.prestadas === 0">
            <i class="pi pi-info-circle"></i>
            Sin actividad reciente
          </span>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon prestamos">
        <i class="pi pi-calendar-plus"></i>
      </div>
      <div class="stat-content">
        <h3>{{ estadisticas.prestamos.total_prestamos }}</h3>
        <p>Pr√©stamos Totales</p>
        <div class="stat-details">
          <span class="stat-item activo" *ngIf="estadisticas.prestamos.activos > 0">
            <i class="pi pi-play-circle"></i>
            {{ estadisticas.prestamos.activos }} activos
          </span>
          <span class="stat-item vencido" *ngIf="estadisticas.prestamos.vencidos > 0">
            <i class="pi pi-exclamation-triangle"></i>
            {{ estadisticas.prestamos.vencidos }} vencidos
          </span>
          <span class="stat-item info" *ngIf="estadisticas.prestamos.activos === 0 && estadisticas.prestamos.vencidos === 0">
            <i class="pi pi-info-circle"></i>
            Sin pr√©stamos activos o vencidos
          </span>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon multas">
        <i class="pi pi-dollar"></i>
      </div>
      <div class="stat-content">
        <h3>{{ estadisticas.multas.total_multas }}</h3>
        <p>Multas Generadas</p>
        <div class="stat-details">
          <span class="stat-item pendiente" *ngIf="estadisticas.multas.pendientes > 0">
            <i class="pi pi-clock"></i>
            {{ estadisticas.multas.pendientes }} pendientes
          </span>
          <span class="stat-item pagada" *ngIf="estadisticas.multas.pagadas > 0">
            <i class="pi pi-check"></i>
            {{ estadisticas.multas.pagadas }} pagadas
          </span>
          <span class="stat-item info" *ngIf="estadisticas.multas.pendientes === 0 && estadisticas.multas.pagadas === 0">
            <i class="pi pi-info-circle"></i>
            Sin multas pendientes o pagadas
          </span>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon usuarios">
        <i class="pi pi-users"></i>
      </div>
      <div class="stat-content">
        <h3>{{ estadisticas.usuarios.total_usuarios }}</h3>
        <p>Usuarios Registrados</p>
        <div class="stat-details">
          <span class="stat-item activo" *ngIf="estadisticas.usuarios.activos > 0">
            <i class="pi pi-user"></i>
            {{ estadisticas.usuarios.activos }} activos
          </span>
          <span class="stat-item info" *ngIf="estadisticas.usuarios.activos === 0">
            <i class="pi pi-info-circle"></i>
            Sin usuarios activos
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuraci√≥n de reportes -->
  <div class="config-section">
    <div class="config-card">
      <div class="config-header">
        <h3><i class="pi pi-cog"></i> Configuraci√≥n del Reporte</h3>
        <p>Personaliza los par√°metros para generar reportes espec√≠ficos</p>
      </div>

      <!-- Mensajes de error del formulario -->
      <div class="form-errors" *ngIf="hasFormErrors">
        <div class="error-message" *ngFor="let error of getFormErrors()">
          <i class="pi pi-exclamation-triangle"></i>
          {{ error }}
        </div>
      </div>

      <form [formGroup]="reportForm" class="config-form">
        <div class="form-row">
          <div class="form-group">
            <label for="tipoReporte">
              <i class="pi pi-file"></i>
              Tipo de Reporte
              <span class="required">*</span>
            </label>
            <p-select
              id="tipoReporte"
              formControlName="tipoReporte"
              [options]="tiposReporte"
              optionLabel="label"
              optionValue="value"
              placeholder="Selecciona un tipo de reporte"
              [class.is-invalid]="f['tipoReporte'].invalid && formSubmitted"
              class="form-control">
            </p-select>
            <div class="error-message" *ngIf="f['tipoReporte'].invalid && formSubmitted">
              {{ getErrorMessage('tipoReporte') }}
            </div>
          </div>

          <div class="form-group" *ngIf="f['tipoReporte'].value && f['tipoReporte'].value !== 'estadisticas'">
            <label for="estado">
              <i class="pi pi-filter"></i>
              Estado
            </label>
            <p-select
              id="estado"
              formControlName="estado"
              [options]="estados"
              optionLabel="label"
              optionValue="value"
              placeholder="Filtrar por estado"
              class="form-control">
            </p-select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="rangoFechas">
              <i class="pi pi-calendar"></i>
              Rango de Fechas
              <span class="required">*</span>
            </label>
            <app-custom-date-range
              formControlName="rangoFechas"
              startPlaceholder="Fecha inicio"
              endPlaceholder="Fecha fin"
              separatorText="a"
              [showActions]="true"
              [class.is-invalid]="(f['rangoFechas'].invalid && formSubmitted) || showDateRangeErrors">
            </app-custom-date-range>
             <div class="error-message" *ngIf="(f['rangoFechas'].invalid && formSubmitted) || showDateRangeErrors">
               {{ getErrorMessage('rangoFechas') }}
             </div>
             <div class="info-message">
               <i class="pi pi-info-circle"></i>
               <strong>Las fechas son obligatorias para todos los reportes.</strong> Usa los botones r√°pidos (Hoy, Esta semana, Este mes) o ingresa fechas personalizadas. Se han asignado fechas por defecto como sugerencia inicial.
             </div>
          </div>
        </div>

        <div class="form-row" *ngIf="f['tipoReporte'].value === 'herramientas-populares'">
          <div class="form-group">
            <label for="limiteHerramientas">
              <i class="pi pi-list"></i>
              L√≠mite de Herramientas
              <span class="required">*</span>
            </label>
            <input
              type="number"
              id="limiteHerramientas"
              formControlName="limiteHerramientas"
              min="1"
              max="100"
              [class.is-invalid]="f['limiteHerramientas'].invalid && formSubmitted"
              class="form-control">
            <div class="error-message" *ngIf="f['limiteHerramientas'].invalid && formSubmitted">
              {{ getErrorMessage('limiteHerramientas') }}
            </div>
          </div>
        </div>

        <div class="form-actions">
          <p-button
            label="Generar Reporte PDF"
            icon="pi pi-file-pdf"
            (onClick)="generarReporte()"
            [loading]="loading"
            [disabled]="!isFormValid"
            styleClass="p-button-primary">
          </p-button>

          <p-button
            label="Limpiar Filtros"
            icon="pi pi-refresh"
            styleClass="p-button-outlined"
            (onClick)="limpiarFiltros()"
            [disabled]="loading">
          </p-button>
        </div>

        <div class="loading-indicator" *ngIf="loading">
          <div class="loading-content">
            <p-progressSpinner strokeWidth="4"></p-progressSpinner>
            <p>Generando reporte...</p>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Reportes recientes -->
  <div class="recent-reports-section top-6" style="margin-top: 20px;" *ngIf="reportes.length > 0">
    <div class="recent-header">
      <h3><i class="pi pi-history"></i> Reportes Generados Recientemente</h3>
      <div class="recent-header-actions">
        <span class="recent-count">{{ reportes.length }} reportes</span>
        <p-button
          label="Borrar Todos"
          icon="pi pi-trash"
          styleClass="p-button-danger p-button-sm"
          (onClick)="borrarTodosLosReportes()"
          pTooltip="Eliminar todos los reportes">
        </p-button>
      </div>
    </div>

    <div class="reports-grid">
      <div
        class="report-card"
        *ngFor="let reporte of reportes; trackBy: trackByReporte; let i = index">
        <div class="report-icon">
          <i class="pi pi-file-pdf"></i>
        </div>
        <div class="report-content">
          <h4>{{ reporte.nombre }}</h4>
          <p>{{ reporte.descripcion }}</p>
          <div class="report-meta">
            <span class="report-date">
              <i class="pi pi-calendar"></i>
              {{ reporte.fecha | date:'short' }}
            </span>
          </div>
        </div>
        <div class="report-actions">
          <p-button
            icon="pi pi-trash"
            styleClass="p-button-text p-button-danger p-button-sm"
            (onClick)="borrarReporte(i)"
            pTooltip="Eliminar reporte">
          </p-button>
        </div>
      </div>
    </div>
  </div>

  <!-- Estado vac√≠o -->
  <div class="empty-state" *ngIf="reportes.length === 0">
    <div class="empty-content">
      <div class="empty-icon">
        <i class="pi pi-file-pdf"></i>
      </div>
      <h3>No hay reportes generados</h3>
      <p>Los reportes que generes aparecer√°n aqu√≠ para acceso r√°pido</p>
      <p-button
        label="Generar mi primer reporte"
        icon="pi pi-plus"
        styleClass="p-button-outlined"
        (onClick)="scrollToConfig()">
      </p-button>
    </div>
  </div>
</div>

<!-- MODAL PERSONALIZADO DE CONFIRMACI√ìN -->
<div *ngIf="showCustomConfirm" class="fixed inset-0 z-modal-confirm flex items-center justify-center bg-black bg-opacity-40">
  <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative" style="background: #fff;">
    <button type="button" (click)="onCustomConfirmReject()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 focus:outline-none text-2xl">
      <span class="material-symbols-outlined">close</span>
    </button>
    <div class="flex flex-col items-start">
      <i class="material-symbols-outlined text-6xl mb-4"
        [ngClass]="{
          'text-danger': confirmIcon === 'delete',
          'text-warning': confirmIcon === 'warning'
        }"
      >{{ confirmIcon }}</i>
      <div class="text-left mb-6">
        <div [innerHTML]="confirmMessage"></div>
      </div>
      <div class="flex gap-4 self-end">
        <button type="button"
          class="custom-cancel-btn px-4 py-2 font-semibold w-24 text-center"
          (click)="onCustomConfirmReject()"
        >Cancelar</button>
        <button type="button"
          [ngClass]="confirmIcon === 'delete' ? 'custom-confirm-accept-danger' : 'custom-confirm-accept-warning'"
          class="px-4 py-2 rounded font-semibold w-24 text-center"
          (click)="onCustomConfirmAccept()"
        >Aceptar</button>
      </div>
    </div>
  </div>
</div>
