<p-toast></p-toast>
<div class="p-6">
    <!-- Skeleton para toda la tabla (headers + datos) -->
    <div *ngIf="loading" class="bg-white rounded-lg shadow-md overflow-hidden">
        <!-- Header skeleton -->
        <div class="bg-[var(--secundary-color)] text-white p-3">
            <div class="flex items-center space-x-4">
                <p-skeleton height="1.5rem" width="60px" styleClass="bg-white/20"></p-skeleton>
                <p-skeleton height="1.5rem" width="100px" styleClass="bg-white/20"></p-skeleton>
                <p-skeleton height="1.5rem" width="120px" styleClass="bg-white/20"></p-skeleton>
                <p-skeleton height="1.5rem" width="80px" styleClass="bg-white/20"></p-skeleton>
                <p-skeleton height="1.5rem" width="140px" styleClass="bg-white/20"></p-skeleton>
                <p-skeleton height="1.5rem" width="140px" styleClass="bg-white/20"></p-skeleton>
                <p-skeleton height="1.5rem" width="180px" styleClass="bg-white/20"></p-skeleton>
                <p-skeleton height="1.5rem" width="140px" styleClass="bg-white/20"></p-skeleton>
                <p-skeleton height="1.5rem" width="120px" styleClass="bg-white/20"></p-skeleton>
                <p-skeleton height="1.5rem" width="120px" styleClass="bg-white/20"></p-skeleton>
                <p-skeleton height="1.5rem" width="80px" styleClass="bg-white/20"></p-skeleton>
            </div>
        </div>
        <!-- Filas skeleton -->
        <div class="p-4 space-y-3">
            <div *ngFor="let item of [1,2,3,4,5]" class="flex items-center space-x-4 py-3 border-b border-gray-100 last:border-b-0">
                <p-skeleton height="1rem" width="60px"></p-skeleton>
                <p-skeleton height="1rem" width="100px"></p-skeleton>
                <p-skeleton height="1rem" width="120px"></p-skeleton>
                <p-skeleton height="1rem" width="80px"></p-skeleton>
                <p-skeleton height="1rem" width="140px"></p-skeleton>
                <p-skeleton height="1rem" width="140px"></p-skeleton>
                <p-skeleton height="1rem" width="180px"></p-skeleton>
                <p-skeleton height="1rem" width="140px"></p-skeleton>
                <p-skeleton height="1rem" width="120px"></p-skeleton>
                <p-skeleton height="1rem" width="120px"></p-skeleton>
                <p-skeleton height="1rem" width="80px"></p-skeleton>
            </div>
        </div>
    </div>

    <!-- Content when loaded -->
    <div *ngIf="!loading">
        <p-table
            #dt
            [value]="loans"
            [rows]="10"
            [paginator]="true"
            [globalFilterFields]="['id', 'folio', 'usuario_nombre', 'usuario_email', 'estado']"
            [tableStyle]="{ 'min-width': '75rem' }"
            [rowHover]="true"
            dataKey="id"
            [showCurrentPageReport]="false"
            [rowsPerPageOptions]="[10, 20, 30]"
            class="shadow-md rounded-lg"
            [loading]="loading"
        >
            <ng-template #caption>
                <div class="flex items-center justify-between">
                    <h5 class="m-0 p-2 text-[var(--primary-color)]">Consulta de Órdenes de Préstamo</h5>
                    <div class="flex gap-2">
                        <p-button
                            (click)="loadLoans()"
                            [loading]="loading"
                            styleClass="p-button-outlined p-button-sm"
                            pTooltip="Actualizar lista"
                            tooltipPosition="top">
                            <ng-template pTemplate="icon">
                                <i class="material-symbols-outlined">refresh</i>
                            </ng-template>
                        </p-button>
                    </div>
                </div>
                <div class="flex items-center justify-between gap-4 mt-2">
                    <div class="flex-1 relative">
                        <i class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</i>
                        <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar por ID, folio, usuario, correo o estado..." class="pl-10 w-full" />
                    </div>
                </div>
            </ng-template>
            <ng-template pTemplate="header">
                <tr class="bg-[var(--secundary-color)] text-white">
                    <th pSortableColumn="id">
                        <div class="flex justify-content-center align-items-center">
                            ID
                            <p-sortIcon field="id"></p-sortIcon>
                        </div>
                    </th>
                    <th pSortableColumn="folio">
                        <div class="flex justify-content-center align-items-center">
                            Folio
                            <p-sortIcon field="folio"></p-sortIcon>
                        </div>
                    </th>
                    <th pSortableColumn="usuario_nombre">
                        <div class="flex justify-content-center align-items-center">
                            Usuario / Correo
                            <p-sortIcon field="usuario_nombre"></p-sortIcon>
                        </div>
                    </th>
                    <th pSortableColumn="estado">
                        <div class="flex justify-content-center align-items-center">
                            Estado
                            <p-sortIcon field="estado"></p-sortIcon>
                        </div>
                    </th>
                    <th pSortableColumn="fecha_solicitud">
                        <div class="flex justify-content-center align-items-center">
                            Fecha Solicitud
                            <p-sortIcon field="fecha_solicitud"></p-sortIcon>
                        </div>
                    </th>
                    <th pSortableColumn="fecha_aprobacion">
                        <div class="flex justify-content-center align-items-center">
                            Fecha Aprobación
                            <p-sortIcon field="fecha_aprobacion"></p-sortIcon>
                        </div>
                    </th>
                    <th pSortableColumn="fecha_devolucion_estimada">
                        <div class="flex justify-content-center align-items-center">
                            Fecha Devolución Estimada
                            <p-sortIcon field="fecha_devolucion_estimada"></p-sortIcon>
                        </div>
                    </th>
                    <th pSortableColumn="fecha_devolucion_real">
                        <div class="flex justify-content-center align-items-center">
                            Fecha Devolución Real
                            <p-sortIcon field="fecha_devolucion_real"></p-sortIcon>
                        </div>
                    </th>
                    <th>
                        <div class="flex justify-content-center align-items-center">
                            Tiempo Solicitado
                            <p-sortIcon field="tiempo_solicitado"></p-sortIcon>
                        </div>
                    </th>
                    <th>
                        <div class="flex justify-content-center align-items-center">
                            Tiempo Aprobado
                            <p-sortIcon field="tiempo_aprobado"></p-sortIcon>
                        </div>
                    </th>
                    <th>Acción</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-loan>
                <tr>
                    <td>{{ loan.id }}</td>
                    <td>{{ loan.folio }}</td>
                    <td>
                        <div class="flex flex-col">
                            <span class="font-semibold text-gray-900">{{ loan.usuario_nombre }}</span>
                            <span class="text-xs text-gray-500">{{ loan.usuario_email || 'Sin correo' }}</span>
                        </div>
                    </td>
                    <td>
                        <span class="px-3 py-1 rounded-full text-sm font-medium flex items-center gap-1"
                              [ngClass]="{
                                  'bg-[rgba(76,217,100,0.2)] text-[var(--color-success)]': loan.estado?.toLowerCase() === 'aprobado',
                                  'bg-[rgba(245,158,11,0.2)] text-orange-800': loan.estado?.toLowerCase() === 'pendiente',
                                  'bg-[rgba(244,67,54,0.2)] text-[var(--color-danger)]': loan.estado?.toLowerCase() === 'rechazado',
                                  'bg-[rgba(110,172,218,0.2)] text-[var(--secundary-color)]': loan.estado?.toLowerCase() === 'terminado',
                                  'bg-[rgba(255,152,0,0.2)] text-orange-600': loan.estado?.toLowerCase() === 'vencido',
                                  'bg-gray-200 text-gray-700': !['aprobado', 'pendiente', 'rechazado', 'terminado', 'vencido'].includes(loan.estado?.toLowerCase())
                              }">
                            <span *ngIf="loan.estado?.toLowerCase() === 'aprobado'" class="text-xs">
                                <i class="material-symbols-outlined text-sm">check_circle</i>
                            </span>
                            <span *ngIf="loan.estado?.toLowerCase() === 'pendiente'" class="text-xs">
                                <i class="material-symbols-outlined text-sm">pending</i>
                            </span>
                            <span *ngIf="loan.estado?.toLowerCase() === 'rechazado'" class="text-xs">
                                <i class="material-symbols-outlined text-sm">cancel</i>
                            </span>
                            <span *ngIf="loan.estado?.toLowerCase() === 'terminado'" class="text-xs">
                                <i class="material-symbols-outlined text-sm">build</i>
                            </span>
                            <span *ngIf="loan.estado?.toLowerCase() === 'vencido'" class="text-xs">
                                <i class="material-symbols-outlined text-sm">warning</i>
                            </span>
                            <span *ngIf="!['aprobado', 'pendiente', 'rechazado', 'terminado', 'vencido'].includes(loan.estado?.toLowerCase())" class="text-xs">
                                <i class="material-symbols-outlined text-sm">help</i>
                            </span>
                            {{ loan.estado | titlecase }}
                        </span>
                    </td>
                    <td>
                        <div class="flex items-center gap-1 date-cell" [ngClass]="getDateCellClasses(loan.fecha_solicitud, 'solicitud')">
                            <span *ngIf="getDateStatus(loan.fecha_solicitud, 'solicitud').icon" class="status-icon">
                                <i class="material-symbols-outlined text-sm">{{ getDateStatus(loan.fecha_solicitud, 'solicitud').icon }}</i>
                            </span>
                            <span [ngClass]="[getDateStatus(loan.fecha_solicitud, 'solicitud').color, getDateStatus(loan.fecha_solicitud, 'solicitud').fontWeight]">
                                {{ loan.fecha_solicitud ? (loan.fecha_solicitud | date:'dd/MM/yy') : getDateStatus(loan.fecha_solicitud, 'solicitud').text }}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="flex items-center gap-1 date-cell" [ngClass]="getDateCellClasses(loan.fecha_aprobacion, 'aprobacion')">
                            <span *ngIf="getDateStatus(loan.fecha_aprobacion, 'aprobacion').icon" class="status-icon">
                                <i class="material-symbols-outlined text-sm">{{ getDateStatus(loan.fecha_aprobacion, 'aprobacion').icon }}</i>
                            </span>
                            <span [ngClass]="[getDateStatus(loan.fecha_aprobacion, 'aprobacion').color, getDateStatus(loan.fecha_aprobacion, 'aprobacion').fontWeight]">
                                {{ loan.fecha_aprobacion ? (loan.fecha_aprobacion | date:'dd/MM/yy') : getDateStatus(loan.fecha_aprobacion, 'aprobacion').text }}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="flex items-center gap-1 date-cell" [ngClass]="getDateCellClasses(loan.fecha_devolucion_estimada, 'devolucion_estimada')">
                            <span *ngIf="getDateStatus(loan.fecha_devolucion_estimada, 'devolucion_estimada').icon" class="status-icon">
                                <i class="material-symbols-outlined text-sm">{{ getDateStatus(loan.fecha_devolucion_estimada, 'devolucion_estimada').icon }}</i>
                            </span>
                            <span [ngClass]="[getDateStatus(loan.fecha_devolucion_estimada, 'devolucion_estimada').color, getDateStatus(loan.fecha_devolucion_estimada, 'devolucion_estimada').fontWeight]">
                                {{ loan.fecha_devolucion_estimada ? (loan.fecha_devolucion_estimada | date:'dd/MM/yy') : getDateStatus(loan.fecha_devolucion_estimada, 'devolucion_estimada').text }}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="flex items-center gap-1 date-cell" [ngClass]="getDateCellClasses(loan.fecha_devolucion_real, 'devolucion_real')">
                            <span *ngIf="getDateStatus(loan.fecha_devolucion_real, 'devolucion_real').icon" class="status-icon">
                                <i class="material-symbols-outlined text-sm">{{ getDateStatus(loan.fecha_devolucion_real, 'devolucion_real').icon }}</i>
                            </span>
                            <span [ngClass]="[getDateStatus(loan.fecha_devolucion_real, 'devolucion_real').color, getDateStatus(loan.fecha_devolucion_real, 'devolucion_real').fontWeight]">
                                {{ loan.fecha_devolucion_real ? (loan.fecha_devolucion_real | date:'dd/MM/yy') : getDateStatus(loan.fecha_devolucion_real, 'devolucion_real').text }}
                            </span>
                        </div>
                    </td>
                    <td>
                        <span class="time-cell" [ngClass]="[getTimeCellClasses(loan.tiempo_solicitado, 'solicitado'), getTimeStatus(loan.tiempo_solicitado, 'solicitado').color, getTimeStatus(loan.tiempo_solicitado, 'solicitado').fontWeight]">
                            {{ loan.tiempo_solicitado ? (loan.tiempo_solicitado | timeFormat) : getTimeStatus(loan.tiempo_solicitado, 'solicitado').text }}
                        </span>
                    </td>
                    <td>
                        <span class="time-cell" [ngClass]="[getTimeCellClasses(loan.tiempo_aprobado, 'aprobado'), getTimeStatus(loan.tiempo_aprobado, 'aprobado').color, getTimeStatus(loan.tiempo_aprobado, 'aprobado').fontWeight]">
                            {{ loan.tiempo_aprobado ? (loan.tiempo_aprobado | timeFormat) : getTimeStatus(loan.tiempo_aprobado, 'aprobado').text }}
                        </span>
                    </td>
                    <td>
                        <p-button
                            styleClass="custom-flat-icon-button custom-flat-icon-button-edit mr-2"
                            (click)="viewDetails(loan)"
                            pTooltip="Ver detalles"
                            tooltipPosition="top">
                            <ng-template pTemplate="icon">
                                <i class="material-symbols-outlined">visibility</i>
                            </ng-template>
                        </p-button>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="11" class="text-center py-8">
                        <div class="flex flex-col items-center gap-2">
                            <i class="material-symbols-outlined text-4xl text-gray-400">inbox</i>
                            <span class="text-gray-500">No se encontraron órdenes de préstamo</span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- Modal de Detalles -->
<p-dialog
    [(visible)]="showDetailModal"
    header="Detalles de la Orden de Préstamo"
    [modal]="true"
    [style]="{ width: isMobile ? '95vw' : '90rem', maxWidth: '95vw' }"
    [draggable]="false"
    [resizable]="false"
    (onHide)="closeDetailModal()"
>
    <!-- Alerta Modal -->
    <app-modal-alert
        [alert]="modalAlert"
        (close)="hideModalAlert()">
    </app-modal-alert>

    <div *ngIf="loadingDetails" class="flex justify-center py-8">
        <i class="material-symbols-outlined text-2xl animate-spin">sync</i>
    </div>

    <div *ngIf="!loadingDetails">
        <p-table
            [value]="selectedLoanDetails"
            [tableStyle]="{ 'min-width': isMobile ? '100%' : '80rem' }"
            [rowHover]="true"
            class="shadow-sm rounded-lg"
        >
            <ng-template pTemplate="header">
                <tr class="bg-gray-50">
                    <th>Herramienta</th>
                    <th>Folio</th>
                    <th>Categoría</th>
                    <th>Subcategoría</th>
                    <th>Cantidad</th>
                    <th>Stock Actual</th>
                    <th>Valor Reposición</th>
                    <th>Fecha Registro</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-detail>
                <tr>
                    <td>
                        <div class="font-medium">{{ detail.herramienta_nombre }}</div>
                    </td>
                    <td>
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
                            {{ detail.herramienta_folio }}
                        </span>
                    </td>
                    <td>{{ detail.categoria_nombre || '-' }}</td>
                    <td>{{ detail.subcategoria_nombre || '-' }}</td>
                    <td>
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">
                            {{ detail.cantidad }}
                        </span>
                    </td>
                    <td>
                        <span class="px-2 py-1 rounded text-xs font-medium"
                              [ngClass]="{
                                  'bg-red-100 text-red-800': detail.herramienta_stock <= 0,
                                  'bg-yellow-100 text-yellow-800': detail.herramienta_stock <= 5 && detail.herramienta_stock > 0,
                                  'bg-green-100 text-green-800': detail.herramienta_stock > 5
                              }">
                            {{ detail.herramienta_stock }}
                        </span>
                    </td>
                    <td>
                        <span class="text-sm font-bold text-gray-700">
                            ${{ detail.valor_reposicion ? detail.valor_reposicion.toLocaleString() : '0' }}
                        </span>
                    </td>
                    <td>{{ detail.created_at ? (detail.created_at | date:'dd/MM/yy h:mm a') : '-' }}</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <div class="flex flex-col items-center gap-2">
                            <i class="material-symbols-outlined text-2xl text-gray-400">build</i>
                            <span class="text-gray-500">No hay herramientas registradas</span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</p-dialog>
